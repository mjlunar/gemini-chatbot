<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col h-screen">
  <!-- 상단: API 키 입력 -->
  <header class="p-4 bg-white shadow flex items-center justify-between">
    <h1 class="text-xl font-semibold">Gemini Chatbot</h1>
    <div>
      <input id="apiKeyInput" type="password" placeholder="Google AI Studio API 키 입력"
        class="border rounded px-3 py-2 w-72 text-sm" />
    </div>
  </header>

  <!-- 채팅창 -->
  <main id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
    <!-- 대화 내용이 여기에 동적으로 추가됨 -->
  </main>

  <!-- 로딩 스피너 -->
  <div id="loading" class="hidden flex justify-center items-center py-2">
    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-700"></div>
    <span class="ml-2 text-gray-700 text-sm">응답 생성 중...</span>
  </div>

  <!-- 하단 입력창 -->
  <form id="chat-form" class="p-4 bg-white shadow flex">
    <input id="message-input" type="text" placeholder="메시지를 입력하세요..."
      class="flex-1 border rounded-l px-3 py-2 focus:outline-none" required />
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-r hover:bg-blue-600">
      전송
    </button>
  </form>

  <script>
    // === 시스템 프롬프트 (AI의 역할 정의) ===
    const SYSTEM_PROMPT = `
      짐은 조선의 왕이다. 과인의 지식으로 백성을 가르쳐라. 말투는 매우 근엄하고 장엄해야 한다.
    `;

    let conversationHistory = [];

    const chatWindow = document.getElementById("chat-window");
    const chatForm = document.getElementById("chat-form");
    const messageInput = document.getElementById("message-input");
    const loading = document.getElementById("loading");
    const apiKeyInput = document.getElementById("apiKeyInput");

    let apiKey = "";

    // --- 유틸 함수: 말풍선 추가 ---
    function addMessage(role, text) {
      const bubble = document.createElement("div");
      bubble.classList.add("p-3", "rounded-lg", "max-w-[80%]", "whitespace-pre-wrap");
      if (role === "user") {
        bubble.classList.add("bg-blue-500", "text-white", "self-end", "ml-auto");
      } else {
        bubble.classList.add("bg-gray-300", "text-gray-800");
      }
      bubble.textContent = text;
      const wrapper = document.createElement("div");
      wrapper.classList.add("flex", "flex-col", role === "user" ? "items-end" : "items-start");
      wrapper.appendChild(bubble);
      chatWindow.appendChild(wrapper);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // --- Gemini API 호출 ---
    async function callGeminiAPI(messages) {
      const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
      try {
        const res = await fetch(`${url}?key=${apiKey}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
            contents: messages
          })
        });

        if (!res.ok) throw new Error("API 요청 실패");
        const data = await res.json();
        return data?.candidates?.[0]?.content?.parts?.[0]?.text || "응답을 가져올 수 없습니다.";
      } catch (err) {
        console.error(err);
        return "⚠️ 오류가 발생했습니다. API 키를 확인하거나 나중에 다시 시도해주세요.";
      }
    }

    // --- 대화 전송 처리 ---
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const userMessage = messageInput.value.trim();
      if (!userMessage) return;
      messageInput.value = "";

      addMessage("user", userMessage);
      conversationHistory.push({ role: "user", parts: [{ text: userMessage }] });

      loading.classList.remove("hidden");

      const reply = await callGeminiAPI(conversationHistory);
      loading.classList.add("hidden");

      addMessage("model", reply);
      conversationHistory.push({ role: "model", parts: [{ text: reply }] });
    });

    // --- API 키 입력 시 첫 인사 ---
    apiKeyInput.addEventListener("change", async () => {
      apiKey = apiKeyInput.value.trim();
      if (!apiKey) return;

      loading.classList.remove("hidden");
      const greetingPrompt = "시스템 프롬프트에 맞게 첫 인사 메시지를 생성해줘.";
      conversationHistory = [{ role: "user", parts: [{ text: greetingPrompt }] }];
      const greeting = await callGeminiAPI(conversationHistory);
      loading.classList.add("hidden");

      addMessage("model", greeting);
      conversationHistory.push({ role: "model", parts: [{ text: greeting }] });
    });
  </script>
</body>
</html>
